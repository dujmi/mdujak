---
import { getCollection, render } from "astro:content";
import Layout from "../layouts/Layout.astro";
import Nav from "@/components/Nav.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

const options: Intl.DateTimeFormatOptions = {
  year: "numeric",
  month: "long",
  day: "numeric",
};

const schema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: post.data.title,
  description: post.data.description,
  image: "https://example.com/og_image.png",
  author: {
    "@type": "Person",
    name: "Mislav Dujak",
  },
  publisher: {
    "@type": "Person",
    name: "Mislav Dujak",
  },
  datePublished: post.data.date,
};

const posts = await getCollection("blog");
const sortedPosts = posts
  .filter((p) => p.id !== post.id)
  .sort(
    (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
  );
---

<Layout
  title={post.data.title}
  description={post.data.description}
  schema={schema}
>
  <Nav subtitle={post.data.date.toLocaleDateString("en-GB", options)} />
  <header class="pt-14 pb-20">
    <hgroup class="flex flex-col items-center justify-center gap-2.5">
      <h1
        class="text-5xl font-bold font-serif leading-[1.1] text-left md:text-center text-balance"
      >
        {post.data.title}
      </h1>
      <p
        class="text-left md:text-center italic text-md-muted text-xl leading-[1.55] md:max-w-2xl text-pretty"
      >
        {post.data.subtitle}
      </p>
    </hgroup>
  </header>
  <hr class="w-32 h-px border-md-separator mx-auto pb-12" />
  <article
    class="w-full text-lg leading-[1.55] [&>p]:pb-10 md:text-justify [&>h2]:text-xl [&>h2]:font-bold [&>h2]:font-serif [&>h2]:pt-8 [&>h2]:pb-8 md:[&>h2]:text-center md:[&>h2]:text-pretty md:[&>h2]:max-w-2xl md:[&>h2]:mx-auto"
  >
    <Content />
  </article>
  {
    sortedPosts.length > 0 && (
      <section class="w-full pt-12">
        <h3 class="font-serif text-md-muted uppercase pb-1.5">Read also</h3>
        <ul class="w-full py-3 ps-3 md:ps-6 flex flex-col gap-4 border-s-1 border-md-separator">
          {sortedPosts.map((post) => (
            <li>
              <a
                href={`/${post.id}`}
                class="underline underline-offset-6 decoration-dotted decoration-2 decoration-md-accent"
                data-astro-prefetch="viewport"
              >
                {post.data.title}
              </a>
            </li>
          ))}
        </ul>
      </section>
    )
  }
</Layout>
